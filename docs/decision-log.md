# Architectural Decision Log

This file tracks major architectural decisions using Y-statements. A Y-statement captures the decision context, addressed concerns, chosen option, alternatives considered, intended outcomes, accepted trade-offs, and reasoning.

**Format:** In the context of <use case>, facing <concern>, we decided for <option> and neglected <alternatives>, to achieve <benefits>, accepting <trade-offs>, because <rationale>.

---

## Decision Log

| ID  | Y-Statement | Date | Status | Reference |
|-----|-------------|------|--------|-----------|
| 001 | In the context of **WASM image processing architecture**, facing **multiple encode/decode cycles in operation chaining**, we decided for **stateless API architecture** and neglected **stateful ImageProcessor class refactor**, to achieve **simple API maintenance, dual-image operation support, memory safety, and architectural simplicity**, accepting **redundant PNG encoding for sequential operations**, because: (1) **Premature optimization** - no profiling data showing encode/decode is actually slow; (2) **Poor architectural fit** - 35% of functions are dual-image operations (combine_*) which don't map to stateful single-image processor; (3) **High complexity cost** - requires rewriting all 23 functions as methods, complete overhaul of www/app.js (lines 225-372), manual memory management (.free() calls) with leak risk, and destructive operations breaking the "try different filters" workflow; (4) **Solution seeking a problem** - UI design doesn't encourage heavy operation chaining. | 2025-11-19 | Active | tasks/TASK-001-stateful-wasm.md |
| 002 | In the context of **overlay image compositing with transparency**, facing **incorrect alpha blending causing visual artifacts with semi-transparent overlays**, we decided for **Porter-Duff "over" operator** and neglected **simple linear interpolation (lerp)**, to achieve **mathematically correct alpha compositing, visual accuracy matching industry standards (Photoshop/GIMP), and proper transparency handling**, accepting **slightly increased computational complexity for color blending**, because: (1) **Mathematical correctness** - lerp formula `color = color_overlay * opacity + color_base * (1.0 - opacity)` ignores the overlay's inherent alpha channel, only considering the opacity parameter; (2) **Industry standard** - Porter-Duff is the universally adopted compositing operator in professional image editing software and W3C specifications; (3) **User expectations** - semi-transparent PNG overlays (e.g., lightning.png) should render transparently, showing the base image through them, not as opaque; (4) **Alpha modulation correctness** - the opacity parameter should modulate the overlay's existing alpha (e.g., 50% opacity makes a semi-transparent overlay even more transparent), which only works with proper compositing math. | 2025-11-20 | Active | src/lib.rs:550-584 |
| 003 | In the context of **filter application semantics**, facing **fundamentally different user expectations for different filter categories**, we decided for **two distinct API patterns: cumulative for transforms, non-cumulative for overlays** and neglected **enforcing uniform stateless API across all filter types**, to achieve **intuitive UX matching user mental models and preserve functional correctness**, accepting **architectural deviation justified by functional requirements**, because: (1) **Different use cases** - transform filters (rotate, flip, crop, split) modify the image state cumulatively; each click changes the working image; (2) **Overlay as non-destructive effect** - transparency/overlay filters are non-cumulative by design; the opacity slider controls the *absolute* effect level, not a delta; clicking multiple times with the same slider position must produce identical results; (3) **User mental model** - users expect the overlay opacity slider to be like a layer opacity in Photoshop, not a cumulative operation; adjusting to 30% and clicking should always produce 30% opacity, not stack; (4) **Implementation requirement** - overlay uses `originalImageData` instead of `imageToFilter` to achieve non-cumulative behavior, which is a functional choice, not a style violation; (5) **Architectural clarity** - documenting this decision makes the deviation explicit and justified for future maintainers. | 2025-11-20 | Active | tasks/002-overlay-filter-architecture.md |
